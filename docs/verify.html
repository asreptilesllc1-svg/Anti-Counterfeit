<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Product Verification</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
    body {
        background: #f5f5f5;
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        height: 100vh;
        justify-content: center;
        align-items: center;
        text-align: center;
    }

    #container {
        width: 90%;
        max-width: 600px;
    }

    #status {
        font-size: 28px;
        margin-bottom: 20px;
        font-weight: bold;
    }

    .auth-success {
        color: green;
    }

    .auth-fail {
        color: red;
    }

    #details {
        font-size: 20px;
        margin-top: 20px;
        line-height: 1.6;
    }

    #loading {
        font-size: 28px;
        font-weight: bold;
        color: #555;
    }
</style>
</head>

<body>
<div id="container">
    <div id="loading">Checking token…</div>
    <div id="status"></div>
    <div id="details"></div>
</div>

<script>
async function verifyToken() {
    const url = new URL(window.location.href);
    let token = url.searchParams.get("p");

    // If QR contains ONLY raw token (no ?p=)
    if (!token) {
        const raw = window.location.href.split("/verify.html?")[1];
        if (raw) {
            token = raw;
        }
    }

    if (!token) {
        document.getElementById("loading").textContent = "";
        document.getElementById("status").textContent = "No token provided.";
        document.getElementById("status").classList.add("auth-fail");
        return;
    }

    try {
        const response = await fetch(
            "https://anti-counterfeit-backend-new.onrender.com/verify-token",
            {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ signedToken: token })
            }
        );

        const result = await response.json();

        document.getElementById("loading").textContent = "";

        if (result.valid) {
            document.getElementById("status").textContent = "✔ AUTHENTIC";
            document.getElementById("status").classList.add("auth-success");

            const p = result.payload;

            document.getElementById("details").innerHTML = `
                <strong>Product ID:</strong> ${p.id}<br>
                <strong>Name:</strong> ${p.name}<br>
                <strong>Batch:</strong> ${p.batch}<br>
                <strong>Timestamp:</strong> ${new Date(p.timestamp).toLocaleString()}
            `;
        } else {
            document.getElementById("status").textContent = "✖ INVALID TOKEN";
            document.getElementById("status").classList.add("auth-fail");
        }
    } catch (err) {
        document.getElementById("loading").textContent = "";
        document.getElementById("status").textContent = "Server error.";
        document.getElementById("status").classList.add("auth-fail");
    }
}

verifyToken();
</script>

</body>
</html>
